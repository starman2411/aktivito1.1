{% load static %}
{% load category_cascade%}
{% load rows_tags%}
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Activito</title>
    <link rel="icon" href="{% static 'activito.ico' %}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'mystyles.css' %}">
    <link rel="stylesheet" href="{% static 'airdatepicker/air-datepicker.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script><script src="{% static 'airdatepicker/air-datepicker.js' %}"></script>
<!--    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->
    <script src="https://code.jquery.com/jquery-3.6.0.js" type="text/javascript"></script>
    <script src="{% static 'airdatepicker/air-datepicker.js' %}"></script>
    <script src="{% static 'myscripts.js'%}"></script>
</head>

<body>
{% csrf_token %}
<div class="d-flex flex-row  justify-content-between align-items-center p-3 px-md-4 mb-3 bg-white border-bottom box-shadow flex-nowrap" style="max-height: 15vh;">
      <h1 class=" font-weight-normal" style="color: #04E061;">Активито</h1>
      <nav class="my-2 my-md-0 mr-md-3">
        <a class="btn btn-outline-success"  href="{% url 'projects' user.username%}">К проектам</a>
        <a class="btn btn-outline-success" onclick="upload_table()" href="#">Сохранить</a>
      </nav>
</div>


<div class="modal fade" id="LoadFilesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <span>Идёт загрузка...</span>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="LoadTableModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <span>Сохранение...</span>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="LoadTableSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <span>Сохранено успешно!</span>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="ErrorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <span>Ошибка!</span>
      </div>
    </div>
  </div>
</div>

<div class="container d-flex flex-column justify-content-center table-container" style="min-width:100%; height: 85vh; padding: 0 20px;">
    <div style="width: 95vw">
        <div class="d-flex align-items-center mb-2">
            <label for="project-name" style="width:160px; margin-left:8px;" >Название проекта:</label>
            <input type="text" style="width:300px; height:30px;" id="project-name" class="form-control" value="{{project_name}}">
        </div>
        <div class="d-flex align-items-center mb-2">
                <span style="width:120px; margin-left:8px;">Часовой пояс: </span>
                <select id="timezone-selector" class="form-select form-select-sm" style="width:200px">
                    <option value="+02:00">UTC+2 (Калининград)</option>
                    <option value="+03:00" selected>UTC+3 (Москва)</option>
                    <option value="+04:00" >UTC+4 (Самара)</option>
                    <option value="+05:00" >UTC+5 (Екатеринбург)</option>
                    <option value="+06:00" >UTC+6 (Омск)</option>
                    <option value="+07:00" >UTC+7 (Красноярск)</option>
                    <option value="+08:00" >UTC+8 (Иркутск)</option>
                    <option value="+09:00" >UTC+9 (Якутия)</option>
                    <option value="+10:00" >UTC+10 (Владивосток)</option>
                    <option value="+11:00" >UTC+11 (Магадан)</option>
                    <option value="+12:00" >UTC+12 (Камчатка)</option>
                </select>
        </div>
        <div class="d-flex align-items-center mb-2">
              <span style="width:180px; margin-left:8px;">Пресет уникализации: </span>
                  <select id="preset-selector" class="form-select form-select-sm" style="width:200px">
                  {% for preset in presets%}
                  <option value="{{preset.preset_name}}">{{preset.preset_name}}</option>
                  {% endfor %}
              </select>
        </div>
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
            <div class="d-flex flex-row " style="margin-bottom: 8px">
                <label for="hide-end-time-box" style="width:190px; margin-left:8px;">Убрать столбец DateEnd</label>
                <input type="checkbox" id="hide-end-time-box" onchange='hide_end_time()'>
                <label for="hide-type-box" style="width:210px; margin-left:40px;">Убрать столбец GoodsType</label>
                <input type="checkbox" id="hide-type-box" onchange='hide_type()'>
                <label for="hide-subtype-box" style="width:235px; margin-left:40px; ">Убрать столбец GoodsSubType</label>
                <input type="checkbox" style="margin-right:40px" id="hide-subtype-box" onchange='hide_subtype()'>
            </div>
            <div class="d-flex flex-row" >
                <label for="delete-amount-from" style="width:128px; margin:0 8px" >Удалить строки с</label>
                <input type="text" style="width:70px; height:30px;" id="delete-amount-from" class="form-control" value= "">
                <label for="delete-amount-to" style=" margin:0 8px;" >по</label>
                <input type="text" style="width:70px; height:30px;" id="delete-amount-to" class="form-control" value="">
                <button class="btn btn-sm  btn-outline-danger" style="margin-left:12px;" onclick="delete_rows()">Удалить</button>
            </div>
        </div>
        <div>
             <span style="cursor: pointer;margin-left:8px; color:red;" class="text-decoration-none" id="undo-button" onClick="undo()" >Отменить последнее действие
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="red" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
      <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
                    </svg>
            </span>
    </div>
</div>
<div class="container-fluid m-2  border table-wrapper" style="overflow-x: auto;overflow-y: auto; width: 95vw; height: 65vh;">
        {% get_category_cascade as category_cascade%}
        <table class="table">
            <thead>
                <tr>
                    <th class="IdRow-header" scope="col">Id</th>
                    <th scope="col">DateBegin</th>
                    <th scope="col">DateEnd</th>
                    <th scope="col">ListingFee</th>
                    <th scope="col">AdStatus</th>
                    <th scope="col">ContactMethod</th>
                    <th scope="col">CompanyName</th>
                    <th scope="col">ManagerName</th>
                    <th scope="col">ContactPhone</th>
                    <th scope="col">VideoUrl</th>
                    <th scope="col">Address</th>
                    <th scope="col">Category</th>
                    <th scope="col">GoodsType</th>
                    <th scope="col">AdType</th>
                    <th scope="col">GoodsSubType</th>
                    <th scope="col">Condition</th>
                    <th scope="col">Title</th>
                    <th scope="col">Description</th>
                    <th scope="col">Price</th>
                    <th scope="col">PriceType</th>
                    <th scope="col"></th>
                    <th scope="col">Images</th>
                </tr>
            </thead>

            <tbody>
                {%for row in rows %}
                <tr id="row-{{forloop.counter}}">

                    <td class="IdRow d-flex align-items-center">
                        <span style="position:absolute; left:-3px; cursor: pointer;" onclick="delete_row(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="red" class="bi bi-x" viewBox="0 0 16 16">
                                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                        </span>
                        <div class="IdRow-wrapper">
                            <textarea class="form-control" oncontextmenu="raise_id_context(event, 'IdRow-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">{{row|get_item:'Id'}}</textarea>
                        </div>
                    </td>

                    <td class="DateBegin" >
                        <div class="DateBegin-wrapper" >
                            <input type="text" class="form-control" oncontextmenu="raise_date_context(event, 'DateBegin-wrapper')" onchange="manual_input_log(this)"  data-previous="" value="{{row|get_item:'DateBegin'}}">
                        </div>
                    </td>

                    <td class="DateEnd">
                        <div class="DateEnd-wrapper">
                            <input disabled type="text" class="form-control" value="{{row|get_item:'DateEnd'}}">
                        </div>
                    </td>

                    <td class="ListingFee">
                        <div class="ListingFee-wrapper" >
                            <select class="form-select" oncontextmenu="raise_context(event, 'ListingFee-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                                <option selected value="-1"></option>
                                    {% for fee in listing_fees%}
                                    {% if fee.fee == row|get_item:'ListingFee' %}
                                    <option selected value="{{forloop.counter0}}">{{fee.fee}}</option>
                                    {% else %}
                                    <option value="{{forloop.counter0}}">{{fee.fee}}</option>
                                    {%endif%}
                                    {% endfor %}
                            </select>
                        </div>
                    </td>

                    <td class="AdStatus">
                        <div class="AdStatus-wrapper" >
                            <select class="form-select" oncontextmenu="raise_context(event, 'AdStatus-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                                <option selected></option>
                                {% for status in ad_statuses%}
                                {% if status.status == row|get_item:'AdStatus' %}
                                <option selected value="{{forloop.counter0}}">{{status.status}}</option>
                                {% else %}
                                <option value="{{forloop.counter0}}">{{status.status}}</option>
                                {%endif%}
                                {% endfor %}
                            </select>
                        </div>
                    </td>

                    <td class="ContactMethod">
                        <div class="ContactMethod-wrapper">
                            <select class="form-select" oncontextmenu="raise_context(event, 'ContactMethod-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                                <option selected></option>
                                {% for method in contact_methods%}
                                {% if method.method == row|get_item:'ContactMethod' %}
                                <option selected value="{{forloop.counter0}}">{{method.method}}</option>
                                {% else %}
                                <option value="{{forloop.counter0}}">{{method.method}}</option>
                                {%endif%}
                                {% endfor %}
                            </select>
                        </div>
                    </td>

                    <td class="CompanyName">
                        <div class="CompanyName-wrapper" >
                            <textarea class="form-control" oncontextmenu="raise_context(event, 'CompanyName-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">{{row|get_item:'CompanyName'}}</textarea>
                        </div>
                    </td>

                    <td class="ManagerName">
                        <div class="ManagerName-wrapper">
                            <textarea  class="form-control" oncontextmenu="raise_context(event, 'ManagerName-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">{{row|get_item:'ManagerName'}}</textarea>
                        </div>
                    </td>

                    <td class="ContactPhone">
                        <div class="ContactPhone-wrapper">
                            <textarea class="form-control" oncontextmenu="raise_context(event, 'ContactPhone-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">{{row|get_item:'ContactPhone'}}</textarea>
                        </div>
                    </td>

                    <td class="VideoUrl">
                        <div class="VideoUrl-wrapper">
                            <textarea class="form-control" oncontextmenu="raise_context(event, 'VideoUrl-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">{{row|get_item:'VideoUrl'}}</textarea>
                        </div>
                    </td>

                    <td class="Address">
                        <div class="Address-wrapper">
                            <textarea class="form-control" oncontextmenu="raise_context(event, 'Address-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">{{row|get_item:'Address'}}</textarea>
                        </div>
                    </td>

                    <td class="Category">
                        <div class="Category-wrapper dropdown">
                            <select class="form-select"  onchange="fillGoodsTypes(this);manual_input_log(this)" oncontextmenu="raise_context(event, 'Category-wrapper')"  onfocus="save_old_input_value(this)" data-previous="">
                                <option selected></option>
                                {% for category in categories%}
                                {% if category.category_name == row|get_item:'Category' %}
                                <option selected value="{{forloop.counter0}}">{{category.category_name}}</option>
                                {% else %}
                                <option value="{{forloop.counter0}}">{{category.category_name}}</option>
                                {%endif%}
                                {% endfor %}
                             </select>
                        </div>
                    </td>

                    <td class="GoodsType">
                        <div class="GoodsType-wrapper dropdown">
                            <select class="form-select"  onchange="fillGoodsSubTypes(this);manual_input_log(this)" oncontextmenu="raise_context(event, 'GoodsType-wrapper')"  onfocus="save_old_input_value(this)" data-previous="">
                                <option selected></option>
                                {% if row|get_item:'GoodsType' %}
                                <option selected value="{{forloop.counter0}}">{{row|get_item:'GoodsType'}}</option>
                                {%endif%}
                            </select>
                        </div>
                    </td>

                    <td class="AdType">
                        <div class="AdType-wrapper">
                            <select class="form-select" oncontextmenu="raise_context(event, 'AdType-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                                <option selected></option>
                                {% for type in ad_types%}
                                {% if type.type == row|get_item:'AdType' %}
                                <option selected value="{{forloop.counter0}}">{{type.type}}</option>
                                {% else %}
                                <option value="{{forloop.counter0}}">{{type.type}}</option>
                                {%endif%}
                                {% endfor %}
                            </select>
                        </div>
                    </td>

                    <td class="GoodsSubType">
                        <div class="GoodsSubType-wrapper dropdown">
                            <select class="form-select" oncontextmenu="raise_context(event, 'GoodsSubType-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                                <option selected></option>
                                {% if row|get_item:'GoodsSubType' %}
                                <option selected value="{{forloop.counter0}}">{{row|get_item:'GoodsSubType'}}</option>
                                {%endif%}
                            </select>
                        </div>
                    </td>

                    <td class="Condition">
                        <div class="Condition-wrapper">
                            <select class="form-select" oncontextmenu="raise_context(event, 'Condition-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                                <option selected></option>
                                {% for condition in conditions%}
                                {% if condition.condition == row|get_item:'Condition' %}
                                <option selected value="{{forloop.counter0}}">{{condition.condition}}</option>
                                {% else %}
                                <option value="{{forloop.counter0}}">{{condition.condition}}</option>
                                {%endif%}
                                {% endfor %}
                            </select>
                        </div>
                    </td>

                    <td class="Title">
                        <div class="Title-wrapper">
                            <textarea maxlength = "50" class="form-control" oncontextmenu="raise_context(event, 'Title-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">{{row|get_item:'Title'}}</textarea>
                        </div>
                    </td>

                    <td class="Description">
                        <div class="Description-wrapper">
                            <textarea class="form-control"  oncontextmenu="raise_context(event, 'Description-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">{{row|get_item:'Description'}}</textarea>
                        </div>
                    </td>

                    <td class="Price">
                        <div class="Price-wrapper">
                            <textarea class="form-control" oncontextmenu="raise_context(event, 'Price-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">{{row|get_item:'Price'}}</textarea>
                        </div>
                    </td>

                    <td class="PriceType">
                        <div class="PriceType-wrapper">
                            <select class="form-select" oncontextmenu="raise_context(event, 'PriceType-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                                <option selected></option>
                                {% for type in price_types%}
                                {% if type.type == row|get_item:'PriceType' %}
                                <option selected value="{{forloop.counter0}}">{{type.type}}</option>
                                {% else %}
                                <option value="{{forloop.counter0}}">{{type.type}}</option>
                                {%endif%}
                                {% endfor %}
                            </select>
                        </div>
                    </td>

                    <td class="FileInput">
                        <div class="FileInput-wrapper">
                            <input  name="file_{{forloop.counter}}" class="load-files-input mb-1 form-control-sm " type="file" id="file_{{forloop.counter}}" multiple>
                            <button class="btn btn-success btn-sm file-button" onclick="upload_files(this)" >Загрузить</button>
                            <label for="unique-box-{{forloop.counter}}" style=" margin-left:5px;">Уникализировать</label>
                            <input type="checkbox" id="unique-box-{{forloop.counter}}" class="load-files-checkbox">
                        </div>
                    </td>

                    <td class="Images">
                        <div class="Images-wrapper">
                            <textarea class="form-control"  oncontextmenu="raise_context(event, 'Images-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">{{row|get_item:'Images'}}</textarea>
                        </div>
                    </td>
                </tr>
                {%endfor%}
            </tbody>
        </table>

        <div class="d-flex align-items-center mb-5">
            <span style="margin-left: 10px">Добавить строки:</span>
            <input type="text" id="new-rows-amount" class="form-control-sm" style="margin-left:10px;" value="1">
            <span style="cursor: pointer;margin-left:10px;" class="text-decoration-none" id="add-row" onClick="add_row()" >
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#04E061" class="bi bi-plus-square-fill" viewBox="0 0 16 16">
                    <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm6.5 4.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3a.5.5 0 0 1 1 0z"/>
                </svg>
            </span>
        </div>
    </div>
</div>


<script>
let load_files_modal = new bootstrap.Modal(document.getElementById("LoadFilesModal"), {});
let load_table_modal = new bootstrap.Modal(document.getElementById("LoadTableModal"), {});
let load_table_success_modal = new bootstrap.Modal(document.getElementById("LoadTableSuccessModal"), {});
let error_modal = new bootstrap.Modal(document.getElementById("ErrorModal"), {});
let rows = document.querySelectorAll('tbody > tr');

rows.forEach((row,key) => {
    let row_id = row.id.split('-')[1];
    let wrap = row.getElementsByClassName('DateBegin-wrapper')[0];
    let wrap_end = row.getElementsByClassName('DateEnd-wrapper')[0];
    let input_date_begin = wrap.querySelector('input');
    let input_date_end = wrap_end.querySelector('input');
    let air = new AirDatepicker(input_date_begin, {
        timepicker: true,
        dateFormat(date, x=row_id) {
            return get_string_date(date);
        },
        onSelect({date, formattedDate, datepicker}){
            let next_date = new Date(date);
            next_date.setDate(next_date.getDate() + 30);
            input_date_end.value = get_string_date(next_date);
            manual_input_log(datepicker.$el,row_id);
        },
    });

    air.$el.onclick = function(event){if((event.which != 3) ) {
        air.show();
        let row_id = event.currentTarget.parentNode.parentNode.parentNode.id.split('-')[1];
        let date_end_input = document.getElementById(`row-${row_id}`).getElementsByClassName('DateEnd-wrapper')[0].querySelector('input');
        event.currentTarget.dataset.previous = JSON.stringify([event.currentTarget.value, date_end_input.value]);
     }};
});

function fillGoodsTypes(elem) {
    let row_number = Number(elem.parentNode.parentNode.parentNode.id.split('-')[1]);
    const category_cascade = JSON.parse("{{category_cascade|escapejs }}");
    const row = document.getElementById('row-' + String(row_number));
    const goods_type_select = row.getElementsByClassName('GoodsType-wrapper')[0].querySelector('select');
    const goods_subtype_select = row.getElementsByClassName('GoodsSubType-wrapper')[0].querySelector('select');
    const category_select = row.getElementsByClassName('Category-wrapper')[0].querySelector('select');

    let category = null;
    if (category_select.options[category_select.selectedIndex]){
        category = category_select.options[category_select.selectedIndex].text;
    }

    let goods_types = null;
    if (category_cascade[category]){
        goods_types = Object.keys(category_cascade[category]);
    }

    goods_type_select.replaceChildren();
    goods_subtype_select.replaceChildren();
    goods_type_select[0] = new Option('',0);

    if (goods_types){
        goods_types.forEach((element,key) => {
            goods_type_select[key+1] = new Option(element,key+1);
        });
    }
}

function fillGoodsSubTypes(elem) {
    let row_number = Number(elem.parentNode.parentNode.parentNode.id.split('-')[1]);
    const category_cascade = JSON.parse("{{category_cascade|escapejs }}");
    const row = document.getElementById('row-' + String(row_number));
    const goods_subtype_select = row.getElementsByClassName('GoodsSubType-wrapper')[0].querySelector('select');
    const category_select = row.getElementsByClassName('Category-wrapper')[0].querySelector('select');
    const goods_types_select = row.getElementsByClassName('GoodsType-wrapper')[0].querySelector('select');



    let goods_type = null;
    let goods_subtypes = null;
    let category = null;

    if (goods_types_select.options[goods_types_select.selectedIndex]){
        goods_type = goods_types_select.options[goods_types_select.selectedIndex].text;
        if (category_select.options[category_select.selectedIndex]){
            category = category_select.options[category_select.selectedIndex].text;
            if ((category)&&(goods_type)){
                goods_subtypes = category_cascade[category][goods_type];
            }
        }
    }

    goods_subtype_select.replaceChildren();
    goods_subtype_select[0] = new Option('',0);

    if (goods_subtypes) {
        goods_subtypes.forEach((element,key) => {
            goods_subtype_select[key+1] = new Option(element,key);
        });
    }
}





 function pack_to_json() {
    let rows = document.querySelectorAll('tbody > tr');
    let rows_amount = rows.length;
    let table = [];

    function get_select_value(row, class_name) {
        let select = row.getElementsByClassName(class_name)[0].querySelector('select');
        if (select.options[select.selectedIndex]){
            return(select.options[select.selectedIndex].text);
        }
        else{
            return('');
        }
    }

    for (id = 1; id<=rows_amount; id++) {
        let row = document.getElementById('row-'+ String(id));
        let row_string = {
            'Id' : Number(row.getElementsByClassName('IdRow-wrapper')[0].querySelector('textarea').value),
            'DateBegin' : row.getElementsByClassName('DateBegin-wrapper')[0].querySelector('input').value,
            'DateEnd' : row.getElementsByClassName('DateEnd-wrapper')[0].querySelector('input').value,

            'ListingFee' : get_select_value(row, 'ListingFee-wrapper'),
            'AdStatus' : get_select_value(row, 'AdStatus-wrapper'),
            'ContactMethod' : get_select_value(row, 'ContactMethod-wrapper'),

            'CompanyName' : row.getElementsByClassName('CompanyName-wrapper')[0].querySelector('textarea').value,
            'ManagerName' : row.getElementsByClassName('ManagerName-wrapper')[0].querySelector('textarea').value,
            'ContactPhone' : row.getElementsByClassName('ContactPhone-wrapper')[0].querySelector('textarea').value,
            'VideoUrl' : row.getElementsByClassName('VideoUrl-wrapper')[0].querySelector('textarea').value,
            'Address' : row.getElementsByClassName('Address-wrapper')[0].querySelector('textarea').value,

            'Category' : get_select_value(row, 'Category-wrapper'),
            'GoodsType' : get_select_value(row, 'GoodsType-wrapper'),
            'AdType' : get_select_value(row, 'AdType-wrapper'),
            'GoodsSubType' : get_select_value(row, 'GoodsSubType-wrapper'),
            'Condition' : get_select_value(row, 'Condition-wrapper'),

            'Title' : row.getElementsByClassName('Title-wrapper')[0].querySelector('textarea').value,
            'Description' : row.getElementsByClassName('Description-wrapper')[0].querySelector('textarea').value,
            'Price' : row.getElementsByClassName('Price-wrapper')[0].querySelector('textarea').value,

            'PriceType' : get_select_value(row, 'PriceType-wrapper'),
            'Images' : row.getElementsByClassName('Images-wrapper')[0].querySelector('textarea').value,
        };
        if (document.getElementById("hide-end-time-box").checked){
            delete row_string['DateEnd'];
        }
        if (document.getElementById("hide-type-box").checked){
            delete row_string['GoodsType'];
        }
        if (document.getElementById("hide-subtype-box").checked){
            delete row_string['GoodsSubType'];
        }
        table.push(row_string);
    }
    return(JSON.stringify(table));
}
</script>
<script>
const category_cascade = JSON.parse("{{category_cascade|escapejs }}");
const csrf = $("input[name=csrfmiddlewaretoken]").val();

let project_name = String(document.getElementById('project-name').value);

if (project_name == ' '){
    document.getElementById('project-name').value = '12';
}
</script>

<script>
function add_row(next_elem = null, new_id = null, prevent_log = false, prevent_multi = false) {
    let row_amount = 1;
    if (!prevent_multi) {
        row_amount = Number(document.getElementById('new-rows-amount').value);
    }
    const table = document.querySelector('tbody');
    let last_row_id = table.children.length;

    for (let i=0; i<row_amount;i++){
        let last_row = table.querySelector('tr:last-child');
        let row_id = 1;
        let row_id_visible = 1;
        if (new_id ){
            row_id = Number(new_id);
        }
        else{
            if (last_row){
                row_id = Number(last_row.id.split('-')[1]) + 1;
                row_id_visible = Number(last_row.getElementsByClassName('IdRow-wrapper')[0].querySelector('textarea').value) + 1;
            }
        }

        new_row_html = `
              <td class="IdRow d-flex align-items-center">
                   <span style="position:absolute; left:-3px; cursor: pointer;" onclick="delete_row(this)">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="red" class="bi bi-x" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                      </svg>
                  </span>
                  <div class="IdRow-wrapper">
                      <textarea class="form-control" oncontextmenu="raise_id_context(event, 'IdRow-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">${row_id_visible}</textarea>
                  </div>
              </td>
              <td class="DateBegin" >
                  <div class="DateBegin-wrapper" >
                      <input type="text" id="date-begin-${row_id}" class="form-control"  oncontextmenu="raise_date_context(event, 'DateBegin-wrapper')" onchange="manual_input_log(this)"  data-previous="">
                  </div>
              </td>

              <td class="DateEnd">
                  <div class="DateEnd-wrapper">
                      <input type="text" id="date-end-${row_id}" class="form-control" disabled>
                  </div>
              </td>

              <td class="ListingFee">
                  <div class="ListingFee-wrapper" >
                      <select class="form-select" oncontextmenu="raise_context(event, 'ListingFee-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                          <option selected></option>
                          {% for fee in listing_fees%}
                               <option value="{{forloop.counter0}}">{{fee.fee}}</option>
                          {% endfor %}
                      </select>
                  </div>
              </td>

              <td class="AdStatus">
                  <div class="AdStatus-wrapper" >
                      <select class="form-select" oncontextmenu="raise_context(event, 'AdStatus-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                          <option selected></option>
                          {% for status in ad_statuses%}
                               <option value="{{forloop.counter0}}">{{status.status}}</option>
                          {% endfor %}
                      </select>
                  </div>
              </td>

              <td class="ContactMethod">
                  <div class="ContactMethod-wrapper">
                      <select class="form-select" oncontextmenu="raise_context(event, 'ContactMethod-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                          <option selected></option>
                          {% for method in contact_methods%}
                               <option value="{{forloop.counter0}}">{{method.method}}</option>
                          {% endfor %}
                      </select>
                  </div>
              </td>

              <td class="CompanyName">
                  <div class="CompanyName-wrapper" >
                      <textarea class="form-control" oncontextmenu="raise_context(event, 'CompanyName-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous=""></textarea>
                  </div>
              </td>

              <td class="ManagerName">
                  <div class="ManagerName-wrapper">
                      <textarea  class="form-control" oncontextmenu="raise_context(event, 'ManagerName-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous=""></textarea>
                  </div>
              </td>

              <td class="ContactPhone">
                  <div class="ContactPhone-wrapper">
                      <textarea class="form-control" oncontextmenu="raise_context(event, 'ContactPhone-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous=""></textarea>
                  </div>
              </td>

              <td class="VideoUrl">
                  <div class="VideoUrl-wrapper">
                      <textarea class="form-control" oncontextmenu="raise_context(event, 'VideoUrl-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous=""></textarea>
                  </div>
              </td>

              <td class="Address">
                  <div class="Address-wrapper">
                      <textarea class="form-control" oncontextmenu="raise_context(event, 'Address-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous=""></textarea>
                  </div>
              </td>

              <td class="Category">
                  <div class="Category-wrapper dropdown">
                     <select class="form-select"  onchange="fillGoodsTypes(this);manual_input_log(this, )"  oncontextmenu="raise_context(event, 'Category-wrapper')" onfocus="save_old_input_value(this)" data-previous="">
                         <option selected></option>
                         {% for category in categories%}
                           <option value="{{forloop.counter0}}">{{category.category_name}}</option>
                         {% endfor %}
                     </select>
                  </div>
              </td>

              <td class="GoodsType">
                  <div class="GoodsType-wrapper dropdown">
                     <select class="form-select"  onchange="fillGoodsSubTypes(this);manual_input_log(this)" oncontextmenu="raise_context(event, 'GoodsType-wrapper')"  onfocus="save_old_input_value(this)" data-previous="">
                         <option selected></option>
                     </select>
                  </div>
              </td>

              <td class="AdType">
                  <div class="AdType-wrapper">
                      <select class="form-select" oncontextmenu="raise_context(event, 'AdType-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                          <option selected></option>
                          {% for type in ad_types%}
                               <option value="{{forloop.counter0}}">{{type.type}}</option>
                          {% endfor %}
                      </select>
                  </div>
              </td>

              <td class="GoodsSubType">
                  <div class="GoodsSubType-wrapper dropdown">
                     <select class="form-select" oncontextmenu="raise_context(event, 'GoodsSubType-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                         <option selected></option>
                     </select>
                  </div>
              </td>

              <td class="Condition">
                  <div class="Condition-wrapper">
                      <select class="form-select" oncontextmenu="raise_context(event, 'Condition-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                          <option selected></option>
                          {% for condition in conditions%}
                               <option value="{{forloop.counter0}}">{{condition.condition}}</option>
                          {% endfor %}
                      </select>
                  </div>
              </td>

              <td class="Title">
                  <div class="Title-wrapper">
                      <textarea maxlength = "50" class="form-control" oncontextmenu="raise_context(event, 'Title-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous=""></textarea>
                  </div>
              </td>

              <td class="Description">
                  <div class="Description-wrapper">
                      <textarea class="form-control" oncontextmenu="raise_context(event, 'Description-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous=""></textarea>
                  </div>
              </td>

              <td class="Price">
                  <div class="Price-wrapper">
                      <textarea class="form-control" oncontextmenu="raise_context(event, 'Price-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous=""></textarea>
                  </div>
              </td>

              <td class="PriceType">
                  <div class="PriceType-wrapper">
                      <select class="form-select" oncontextmenu="raise_context(event, 'PriceType-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous="">
                          <option selected></option>
                          {% for type in price_types%}
                               <option value="{{forloop.counter0}}">{{type.type}}</option>
                          {% endfor %}
                      </select>
                  </div>
              </td>

              <td class="FileInput">
                  <div class="FileInput-wrapper">
                      <input  name="file_${row_id}" class="load-files-input mb-1 form-control-sm " type="file" id="file_${row_id}" multiple>
                      <button class="btn btn-success btn-sm file-button" onclick="upload_files(this)">Загрузить</button>
                      <label for="unique-box-${row_id}" style=" margin-left:5px;">Уникализировать</label>
                      <input type="checkbox" id="unique-box-${row_id}" class="load-files-checkbox">
                  </div>
              </td>
              <td class="Images">
                  <div class="Images-wrapper">
                      <textarea class="form-control" oncontextmenu="raise_context(event, 'Images-wrapper')" onchange="manual_input_log(this)" onfocus="save_old_input_value(this)" data-previous=""></textarea>
                  </div>
              </td>`;
        const new_row = document.createElement('tr');
        new_row.innerHTML = new_row_html;
        new_row.id = `row-${row_id}`;
        if (next_elem){
            table.insertBefore(new_row, next_elem);
        }
        else{
            table.appendChild(new_row);
        }

        if (document.getElementById("hide-end-time-box").checked) {
            hide_end_time();
        }
        if (document.getElementById("hide-type-box").checked) {
            hide_type();
        }
        if (document.getElementById("hide-subtype-box").checked) {
            hide_subtype();
        }

        let input_date_begin = document.getElementById(`row-${row_id}`).getElementsByClassName('DateBegin-wrapper')[0].querySelector('input');
        let input_date_end = document.getElementById(`row-${row_id}`).getElementsByClassName('DateEnd-wrapper')[0].querySelector('input');

        let air = new AirDatepicker(input_date_begin, {
            timepicker: true,
            dateFormat(date, x=row_id) {
                return get_string_date(date);
            },
            onSelect({date, formattedDate, datepicker}){
                let next_date = new Date(date);
                next_date.setDate(next_date.getDate() + 30);
                input_date_end.value = get_string_date(next_date);
                manual_input_log(datepicker.$el,row_id);
            },
        });
        air.$el.onclick = function(event){if((event.which != 3) ) {
             air.show();
             let row_id = event.currentTarget.parentNode.parentNode.parentNode.id.split('-')[1];
             let date_end_input = document.getElementById(`row-${row_id}`).getElementsByClassName('DateEnd-wrapper')[0].querySelector('input');
             event.currentTarget.dataset.previous = JSON.stringify([event.currentTarget.value, date_end_input.value]);
        };
        }
        }
        if (!prevent_log) {
    addRowsAddLog('add_rows', [last_row_id + 1, last_row_id + row_amount]);
}

}
</script>
<script>
function  upload_files(elem) {
    let row_id = Number(elem.parentNode.parentNode.parentNode.id.split('-')[1]);
    let formData = new FormData();

    let input = document.getElementById(`row-${row_id}`).getElementsByClassName('load-files-input')[0];
    let check_box = document.getElementById(`row-${row_id}`).getElementsByClassName('load-files-checkbox')[0];
    let files = input.files;

    for (k=0;k<files.length;k++) {
        formData.append('files',files[k])
    }
    formData.append("csrfmiddlewaretoken", csrf);
    formData.append("project_name", String(document.getElementById('project-name').value));
    formData.append("make_unique", Number(check_box.checked));
    let preset_selector = document.getElementById('preset-selector');
    formData.append("preset", preset_selector.options[preset_selector.selectedIndex].value);

    if (files.length){
    $.ajax({
        url: "{%url 'load_files'%}",
        dataType: 'json', // what to expect back from server
        cache: false,
        contentType: false,
        processData: false,
        type: 'post',
        data: formData,
        beforeSend: function(){load_files_modal.show();},
        error: function(){
             setTimeout(() => load_files_modal.hide(), 500);
             setTimeout(() => error_modal.show(), 700);
             },
        success: function(response) {
            urls = response['urls'];
            let row = document.getElementById('row-' + String(row_id));
            let images_wrapper = row.getElementsByClassName('Images-wrapper')[0];
            let images_textarea = images_wrapper.querySelector('textarea');
            let previous = images_textarea.value;
            images_textarea.value = urls.join(' | ');
            addLog('load_files_handler1', {'Images-wrapper-1': {'previous': previous,'new': urls.join(' | ')} });

            setTimeout(() => load_files_modal.hide(), 500);

        }
    })
    }
}


function  upload_table() {
    let project_name = String(document.getElementById('project-name').value);
    if (!(project_name)) {
        alert('Введите название проекта!');
        return(false);
    }
    let formData = new FormData();
    formData.append('json_table',pack_to_json());
    formData.append('project_name', document.getElementById('project-name').value);
    formData.append("csrfmiddlewaretoken", csrf);
    $.ajax({
        url: {% url 'load_table'%},
        dataType: 'json', // what to expect back from server
        cache: false,
        contentType: false,
        processData: false,
        type: 'post',
        data: formData,
        beforeSend: function(){load_table_modal.show();},
        error: function(){
             setTimeout(() => load_table_modal.hide(), 500);
             setTimeout(() => error_modal.show(), 700);
         },
        success: function(response) {
            setTimeout(() => load_table_modal.hide(), 500);
            setTimeout(() => load_table_success_modal.show(), 700);


        }
    })
}
</script>

</body>
</html>